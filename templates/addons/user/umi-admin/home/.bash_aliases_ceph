#!/bin/bash
# shellcheck disable=SC1090,SC1091,SC2139

# Ceph stuff
MANAGE_CEPH="/opt/umi/postinstall/manage/manage_ceph_pools.bash"
alias c-manage="$MANAGE_CEPH"
alias c-bootstrap-cluster="$MANAGE_CEPH -a bootstrap-cluster"
alias c-bootstrap-crush="$MANAGE_CEPH -a recreate-all-crush"
alias c-bootstrap-fs="$MANAGE_CEPH -a del-all-fs ; $MANAGE_CEPH -a add-all-fs"
alias c-bootstrap-pools="$MANAGE_CEPH -a recreate-all-pools"
alias c-bootstrap-all="c-bootstrap-cluster ; c-bootstrap-crush ; c-bootstrap-pools"
alias c-clean-fs="$MANAGE_CEPH -a del-all-fs"
alias c-clean-pools="$MANAGE_CEPH -a del-all-pools"
alias c-clean-crush="$MANAGE_CEPH -a del-all-crush"
alias c-clean-all="c-clean-fs ; c-clean-pools ; c-clean-crush"
alias c-s='ceph -s'
alias c-mgr='ceph mgr services'
alias c-df='ceph df detail'
alias c-tree='ceph osd tree'
alias c-poolstat='ceph osd pool stats'
alias c-pools='ceph osd pool ls'
alias c-poolsd='ceph osd pool ls detail'
alias c-rules='ceph osd crush rule ls'
alias c-pg='ceph pg dump pools'
alias c-stats='ceph report'
alias c-stats-pools='ceph osd dump -f json-pretty | jq ".pools[]"'

# Ceph functions
c-rule-export() {
    [[ -z "$1" ]] && echo "Filename required!" && return 1
    echo "Rule export:"
    c-manage -a export-crush -n "$1"
}
c-rule-import() {
    [[ -z "$1" ]] && echo "Filename required!" && return 1
    echo "Rule import:"
    c-manage -a import-crush -n "$1"
}
c-rule-edit() {
    [[ -z "$1" ]] && echo "Filename required!" && return 1
    c-rule-export "$1"
    "$EDITOR" "$1"
    c-rule-import "$1"
}
c-cfg() {
    [[ -z "$1" ]] && echo "Poolname required!" && return 1
    ceph osd pool get "$1" all
}
c-bench() {
    [[ -z "$1" ]] && echo "OSD name required!" && return 1
    ceph tell "$1" bench
}

# Alias config: umi
alias umi-post='cd /opt/umi/postinstall'
alias umi-env='source /opt/umi/config/env.bash'
alias umi-envcat='cat /opt/umi/config/env.bash'

# Alias cfg
alias cfg-bash="$EDITOR ~/.bashrc ; sb"

each_line() {
  local cmd_prefix="$1"
  local cmd_trail="$2"
  
  while IFS= read -r line; do
    if [[ -z "$cmd_trail" ]]; then
      eval "$cmd_prefix \"$line\""
    else
      eval "$cmd_prefix \"$line\" $cmd_trail"
  fi
  done
}


